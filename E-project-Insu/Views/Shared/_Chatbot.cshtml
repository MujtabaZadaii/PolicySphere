@* Views/Shared/_Chatbot.cshtml *@
<div id="chatbot-container" class="fixed bottom-6 right-6 z-[100] font-sans">
    <style>
        #chatbot-messages img {
            max-width: 100%;
            border-radius: 0.75rem;
            margin-top: 0.5rem;
            border: 1px solid rgba(255,255,255,0.1);
        }
        #chatbot-messages p {
            margin-bottom: 0.5rem;
        }
        #chatbot-messages p:last-child {
            margin-bottom: 0;
        }
    </style>
    <!-- Chat Toggle Button -->
    <button id="chatbot-toggle" class="w-14 h-14 bg-accent hover:bg-accent/80 text-white rounded-full shadow-[0_0_20px_rgba(172,88,233,0.5)] flex items-center justify-center transition-all duration-300 transform hover:scale-110">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
        </svg>
    </button>

    <!-- Chat Window -->
    <div id="chatbot-window" class="hidden absolute bottom-16 right-0 w-80 sm:w-96 bg-black/90 backdrop-blur-xl border border-white/10 rounded-2xl shadow-[0_20px_50px_rgba(0,0,0,0.8)] overflow-hidden transition-all duration-300 origin-bottom-right transform scale-95 opacity-0">
        <!-- Header -->
        <div class="bg-gradient-to-r from-accent/20 to-transparent p-4 flex justify-between items-center border-b border-white/5">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-black/50 border border-white/10 flex items-center justify-center overflow-hidden">
                    <!-- Using sidebar close logo as it's likely the icon-only version -->
                    <img src="/logo/sidebar close logo.png" alt="Logo" class="w-full h-full object-contain p-1.5" />
                </div>
                <div>
                    <h3 class="font-display text-white font-bold tracking-wide">PolicySphere</h3>
                    <p class="text-[10px] text-green-400 flex items-center gap-1">
                        <span class="block w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"></span> Online
                    </p>
                </div>
            </div>
            <button id="chatbot-close" class="text-gray-400 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>

        <!-- Messages Area -->
        <div id="chatbot-messages" class="h-80 overflow-y-auto p-4 space-y-4 scrollbar-thin scrollbar-thumb-white/10 scrollbar-track-transparent">
            <!-- Initial Message -->
            <div class="flex items-start gap-2">
                <div class="w-8 h-8 rounded-full bg-white/10 flex-shrink-0 flex items-center justify-center overflow-hidden border border-accent/20">
                    <img src="/logo/sidebar close logo.png" alt="AI" class="w-full h-full object-contain p-1" />
                </div>
                <div class="bg-white/10 rounded-2xl rounded-tl-none p-3 max-w-[80%]">
                    <p class="text-sm text-gray-200">Hello! I am PolicySphere's AI Assistant, created by Mujtaba Zadaii. How can I help you today?</p>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 border-t border-white/5 bg-black/50">
            <form id="chatbot-form" class="flex gap-2">
                <input type="text" id="chatbot-input" placeholder="Type your message..." class="flex-1 bg-white/5 border border-white/10 rounded-xl px-4 py-2 text-sm text-white focus:outline-none focus:border-accent transition-colors placeholder-gray-500" autocomplete="off">
                <button type="submit" class="bg-accent hover:bg-accent/80 text-white p-2 rounded-xl transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transform rotate-90" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                    </svg>
                </button>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const toggleBtn = document.getElementById('chatbot-toggle');
        const closeBtn = document.getElementById('chatbot-close');
        const windowEl = document.getElementById('chatbot-window');
        const form = document.getElementById('chatbot-form');
        const input = document.getElementById('chatbot-input');
        const messagesContainer = document.getElementById('chatbot-messages');
        let isOpen = false;

        // Toggle Chat
        function toggleChat() {
            isOpen = !isOpen;
            if (isOpen) {
                windowEl.classList.remove('hidden');
                // Small delay to allow display:block to apply before opacity transition
                setTimeout(() => {
                    windowEl.classList.remove('scale-95', 'opacity-0');
                    windowEl.classList.add('scale-100', 'opacity-100');
                    input.focus();
                }, 10);
            } else {
                windowEl.classList.remove('scale-100', 'opacity-100');
                windowEl.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    windowEl.classList.add('hidden');
                }, 300);
            }
        }

        toggleBtn.addEventListener('click', toggleChat);
        closeBtn.addEventListener('click', toggleChat);

        // Add Message to UI
        function addMessage(content, isUser = false) {
            const div = document.createElement('div');
            div.className = `flex items-start gap-2 ${isUser ? 'flex-row-reverse' : ''}`;
            
            const avatar = document.createElement('div');
            
            if (isUser) {
                avatar.className = `w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center text-[10px] text-white bg-gray-600`;
                avatar.innerText = 'You';
            } else {
                avatar.className = `w-8 h-8 rounded-full bg-white/10 flex-shrink-0 flex items-center justify-center overflow-hidden border border-accent/20`;
                avatar.innerHTML = `<img src="/logo/sidebar close logo.png" alt="AI" class="w-full h-full object-contain p-1" />`;
            }
            
            const bubble = document.createElement('div');
            bubble.className = `p-3 max-w-[80%] text-sm ${isUser ? 'bg-accent text-white rounded-2xl rounded-tr-none' : 'bg-white/10 text-gray-200 rounded-2xl rounded-tl-none prose prose-invert max-w-none'}`;
            bubble.innerHTML = isUser ? content : marked.parse(content);

            div.appendChild(avatar);
            div.appendChild(bubble);
            messagesContainer.appendChild(div);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Add Loading Indicator
        function addLoading() {
            const div = document.createElement('div');
            div.id = 'chatbot-loading';
            div.className = 'flex items-start gap-2';
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-white/10 flex-shrink-0 flex items-center justify-center overflow-hidden border border-accent/20">
                    <img src="/logo/navbar logo.png" class="w-full h-full object-contain p-1" />
                </div>
                <div class="bg-white/10 rounded-2xl rounded-tl-none p-3">
                    <div class="flex gap-1">
                        <span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce"></span>
                        <span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                        <span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></span>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(div);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function removeLoading() {
            const loading = document.getElementById('chatbot-loading');
            if (loading) loading.remove();
        }

        // Handle Submit
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = input.value.trim();
            if (!message) return;

            addMessage(message, true);
            input.value = '';
            addLoading();

            try {
                const response = await fetch('/Chat/SendMessage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: message }) // Send simplistic object matching controller
                });

                if (!response.ok) {
                    let errorMsg = "Sorry, something went wrong.";
                    try {
                        const errorData = await response.json();
                        // Try to parse more specific error details
                        if (errorData.details) {
                            try {
                                const detailsObj = JSON.parse(errorData.details);
                                if (detailsObj.error && detailsObj.error.message) {
                                    errorMsg = `Error: ${detailsObj.error.message}`;
                                } else if (detailsObj.message) {
                                    errorMsg = `Error: ${detailsObj.message}`;
                                } else {
                                    errorMsg = `Error: ${errorData.details}`;
                                }
                            } catch (e) {
                                errorMsg = `Error: ${errorData.details}`;
                            }
                        } else if (errorData.error) {
                             errorMsg = `Error: ${errorData.error}`;
                        }
                    } catch (e) {
                        const errorText = await response.text();
                        console.error("API Error Text:", errorText);
                        errorMsg = "Server connection failed.";
                    }
                    throw new Error(errorMsg);
                }

                const data = await response.json();
                const reply = data.reply; 
                removeLoading();
                addMessage(reply);

            } catch (error) {
                console.error('Frontend Error:', error);
                removeLoading();
                addMessage(error.message || "An unexpected error occurred.");
            }
        });
    });
</script>
